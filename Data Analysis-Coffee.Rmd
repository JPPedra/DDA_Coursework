---
title: "CS5811-Data Distributed Analysis-Data Analysis on Arabica Coffee Beans"
author: "Hawra Nawrozzadeh, Joao Pedro Azevedo, and Roberta Sammarco"
date: "10/02/2022"
output: html_document
version: 1.0
editor_options: 
  chunk_output_type: inline
---

# 1. Introduction

- The Dataset is on Coffee Arabica Beans 
- The metadata is as followed:

Quality Measures Metadata    
 - Aroma                       
 - Flavor                       
 - Aftertaste                   
 - Acidity                     
 - Body                       
 - Balance              
 - Uniformity              
 - Cup Cleanliness           
 - Sweetness            
 - Moisture                
 - Defects          

Farm Metadata     
- Owner           
- Country of Origin    
- Farm Name            
- Lot Number        
- Mill              
- Company            
- Altitude          
- Region            

Bean Metadata     
- Processing Method 
- Color             
- Species (arabica)

- Research Question: 
"Given the quality measures of the Arabica coffee beans, can we predict where these coffees are originated from?"
"Given the Quality measures of the Arabica Coffee beans, can we predict how these coffee bean was processed?"
"Given the Quality measures of the Arabica Coffee beans, can we predict the overall coffee quality score?"

# 2. Loading the Libraries

```{r}
# For data cleaning and preparation
library(dplyr)
library(tidyverse)
library(validate)
# For Data visualisation
library(ggplot2)
```

# 3. Data Cleaning and Preparation

## 3.1 Loading the data 

```{r}
coffee <- read.csv("ArabicaCoffeeBeans.csv")
```


## 3.2 Data Qaulity Check, Data Cleaning and Preparation 

Let's look into the structure of the data set
```{r}
str(coffee)
summary(coffee)
```

-From the 'summary()' and 'str()' function, it seems R has processed the dataset with  35 attributes categorical variables and the rest of the 9 attributes to be numerical continuous.
- However, this seems to be incorrect format because the in correct datatype.
  - For example, variables such as 'Acidity' and 'Aftertaste' contains numerical observations however, has been processed as character data types.
- Additionally, we can already identify errors such as missing data and possible outliers (from looking at the ranges from the summary function)

- Lets further look into the different levels by creating an object that converts the strings into a factor.
  - using 'stringAsFactor = T'
- By doing this, we can also see other details that we will help us to decide which attributes are redundant or irrelavent for our research question. 
```{r}
coffee_fac_lev <- read.csv("ArabicaCoffeeBeans.csv", stringsAsFactors = T)
str(coffee_fac_lev)
summary(coffee_fac_lev)
```

- There is alot of errors and redudant information
- can see the amount of missings informations, etc. 
(maybe this is where we use the validate package?)

- As a results, in order to answer our research, we will subset the dataset to contain the following variables: 
  - Country.of.Origin       
  - Number.of.Bags               
  - Bag.Weight                                   
  - Processing.Method                             
  - Aroma                                         
  - Flavor                                        
  - Aftertaste                                    
  - Acidity                                       
  - Body                                          
  - Balance                                       
  - Uniformity                                    
  - Clean.Cup                                     
  - Sweetness                                     
  - Cupper.Points                                 
  - Total.Cup.Points                              
  - Moisture                                      
  - Category.One.Defects                          
  - Quakers                                       
  - Category.Two.Defects  

- Will now subset the dataset
```{r} 
# Lets get the column names
colnames(coffee)

# Are subsetting and removing the following columns mainly because all these variables had missing variables and would not help in answering our research question
coffee_new <- coffee %>%
  select(-c( ## removing data regarding the Farm 
            "Owner", "Farm.Name", "Lot.Number", "Mill", "ICO.Number",
            "Company","Region","Producer","In.Country.Partner","Harvest.Year","Owner.1","Variety", "Expiration",
            "Certification.Body","Certification.Address","Certification.Contact","unit_of_measurement",
            ## removing data regard the bean
            "Color", "Species", "Altitude", "altitude_low_meters", "altitude_high_meters", "altitude_mean_meters", "ID", "Grading.Date"
            )
         )
# Let check the new changes
colnames(coffee_new)
str(coffee_new)
summary(coffee_new)
```

- Let's see if there are still any missing rows and if so, let remove them
```{r}
summary(coffee_new)
colSums(is.na(coffee_new))
colSums(coffee_new == "")

#https://stackoverflow.com/questions/42721788/filter-empty-rows-from-a-dataframe-with-r
coffee_new_1 <- coffee_new[Reduce(`&`, lapply(coffee_new, 
                                              function(x) !(x==""))),]

colSums(is.na(coffee_new_1))
colSums(coffee_new_1 == "")
```

# Variables:

# what variables are in the correct data type?

1- Species should be categorical / correct (many wrong imputed values)
2 - Country.of.Origin should be categorical / correct 
3 - Number.of.Bags should be integer / incorrect as it is categorical
4 - Bag.Weight should be integer / incorrect as it is categorical
5 - Processing.Method should be factor / incorrect 
6 - Aroma should be double(numerical) / incorrect as it is categorical
7 - Flavor should be double(numerical) / incorrect as it is categorical
8 - Aftertaste should be double(numerical) / incorrect as it is categorical
9 - Acidity should be double(numerical) / incorrect as it is categorical
10 - Body should be double(numerical) / correct
11 - Balance should be double(numerical) / correct
12 - Uniformity should be double(numerical) / correct
13 - Clean.Cup should be double(numerical) / correct
14 - Sweetness should be double(numerical) / correct
15 - Cupper.Points should be double(numerical) / incorrect as it is categorical
16 - Total.Cup.Points should be double(numerical) / incorrect as it is categorical
17 - Moisture should be double(numerical) / incorrect as it is categorical
18 - Category.One.Defects should be double / incorrect as it is categorical
19 - Quakers should be categorical / correct
20 - Category.Two.Defects should be integer / correct


Perform data type conversion 
- character to factors
- character that hold numbers to double numerical 
- excluding bag weight as the conversion would not work -> both string and "number" and the units are not the same
```{r}
#converting data type as factor
coffee_new_1$Processing.Method<-as.factor(coffee_new_1$Processing.Method)

#converting data type as double numerical
coffee_new_1$Number.of.Bags <- as.double(coffee_new_1$Number.of.Bags)
coffee_new_1$Quakers<-as.factor(coffee_new_1$Quakers)

coffee_new_1$Aroma<-as.double(coffee_new_1$Aroma)
coffee_new_1$Flavor<-as.double(coffee_new_1$Flavor)
coffee_new_1$Aftertaste<-as.double(coffee_new_1$Aftertaste)
coffee_new_1$Acidity<-as.double(coffee_new_1$Acidity)
coffee_new_1$Body<-as.double(coffee_new_1$Body)
coffee_new_1$Balance<-as.double(coffee_new_1$Balance)
coffee_new_1$Uniformity<-as.double(coffee_new_1$Uniformity)
coffee_new_1$Clean.Cup<-as.double(coffee_new_1$Clean.Cup)
coffee_new_1$Total.Cup.Points<-as.double(coffee_new_1$Total.Cup.Points)
coffee_new_1$Cupper.Points<-as.double(coffee_new_1$Cupper.Points)
coffee_new_1$Moisture<-as.double(coffee_new_1$Moisture)
coffee_new_1$Category.One.Defects<-as.double(coffee_new_1$Category.One.Defects) 
#checking the structure of the data set with new data types
str(coffee_new_1)
```

validate (before)
```{r}
coffee.rules <- validator(okID = ID>=0, 
                          SpeciesCorrect = is.element(Species,c("Arabica")), 
                          NoNegAltitude = Altitude>0, 
                          NoExtremeAltitude = Altitude< 200000, 
                          NonNegBags = Number.of.Bags>0, 
                          NonNegWeight = Bag.Weight>0, 
                          CorrectMethod = is.element(Processing.Method,
                                                     c("Washed / Wet", "Natural/ Dry", "Pulped natural / honey", "Semi-washed / Semi-pulped", "Other")), 
                          NoNegAroma = Aroma>0, 
                          NoNegFlavor = Flavor>0, 
                          NoNegAftertaste = Aftertaste>0, 
                          NoNegAcidity = Acidity>0, 
                          NoNegBody = Body>0, 
                          NoNegBalance = Balance>0,  
                          NoNegUniformity = Uniformity>0, 
                          NoExtUniformity = Uniformity<=10,  
                          NoNegCup = Clean.Cup>0, 
                          NoExtClean.Cup  = Clean.Cup <=10,  
                          NoNegSweetness = Sweetness>0, 
                          NoExtSweetness = Sweetness<=10, 
                          NoNegPoints = Cupper.Points>0, 
                          NoExtPoints = Cupper.Points<=10, 
                          NoNegTotalPoints = Total.Cup.Points>0, 
                          NoExtTotalPoints = Total.Cup.Points<=100, 
                          NoNegMoisture = Moisture>0, 
                          NoNegQuakers = Quakers>=0, 
                          ColorCorrect = is.element(Color,
                                                    c("Green", "None" , "Bluish-Green", "Blue-Green")),
                          NoMinaltitute = altitude_low_meters>=1,
                          NoextAltitute = altitude_low_meters <= 190164,
                          NoMinaltitute = altitude_high_meters>=1,
                          NoextAltitute = altitude_high_meters <= 190164,
                          NoMinaltitute = altitude_mean_meters>=1,
                          NoextAltitute = altitude_mean_meters <= 190164
) 

out   <- confront(coffee_new, coffee.rules)
out_1 <- confront(coffee, coffee.rules)
summary(out)
plot(out)
```


```{r}
#count NA values
coffee_NA_count <- apply(is.na(coffee_new_1), 2, sum)
coffee_NA_count
# the percentage of NA per variable
coffee_NA_perc <- coffee_NA_count / dim(coffee_new_1)[1] * 100
coffee_NA_perc
```

- Then apply NA imputation to all numerical variables
```{r}
# impute missing values by replacement with the mean value
  # using mutate_if function and if else condition to find any NAs in any numerical columns and replace it with their according median
coffee_new_1 <- coffee_new_1 %>% 
  mutate_if(is.numeric, function(x) ifelse(is.na(x), median(x, na.rm = T), x))
colSums(is.na(coffee_new_1))

median_Body <- median(coffee_new_1$Body, na.rm = T)
coffee_new_1[is.na(coffee_new_1$Body), 7.500] = median_Body
# 
# median_Balance <- median(coffee_new_1$Balance, na.rm = T)
# coffee_new_1[is.na(coffee_new_1$Balance), 7.500] = median_Balance
# 
# median_Sweetness <- median(coffee_new_1$Sweetness, na.rm = T)
# coffee_new_1[is.na(coffee_new_1$Sweetness), 10.000] = median_Sweetness
# 
# median_Uniformity <- median(coffee_new_1$Uniformity, na.rm = T)
# coffee_new_1[is.na(coffee_new_1$Uniformity), 10.00] = median_Uniformity
# 
# median_Clean.Cup <- median(coffee_new_1$Clean.Cup, na.rm = T)
# coffee_new_1[is.na(coffee_new_1$Clean.Cup), 10.000] = median_Clean.Cup

colSums(is.na(coffee_new_1))
```

-dealing with Bag Weight problem
  - all string 
  - Majority is kg put there are some in lbs
  - Created a function to fix this so that all the values are converted to numeric and all have the same unit
```{r}
# 1) replace NA with fake number as the function below is sensitive to NAs 
coffee_new$Bag.Weight <- coffee_new$Bag.Weight %>% 
  replace_na("99999 kg")

# 2) Check that NAs in Bag weight have been temporarily been replaced
colSums(is.na(coffee_new)) 

# 3) Will write and export this file in order to perform the function in PySpark 
write.csv(coffee_new, file = "Data/Arabica-coffee-half-modified.csv", row.names = FALSE)

# 4) Will now load the results from the function that was performed in Pyspark
coffee_new_1 <- read.csv("Data/ArabicaCoffeeBeansNew-UnitConversionWithString.csv")

# 4) Lets have a look at the `Bag.Weight`
table(coffee_new_1$Bag.Weight)
str(coffee_new)
```

```{r}
# have to change the fake number to NA before doing NA imputation to Bag Weight , will use the naniar function
table(coffee_new_1$Bag.Weight)
library(naniar)
#exp<- coffee_new_1
coffee_new_1 <- coffee_new_1 %>% 
  replace_with_na(replace = list(Bag.Weight = 99999))
table(coffee_new_1$Bag.Weight)
colSums(is.na(coffee_new_1))
```

```{r}
# Then perform NA imputation to Bag weight

median_Bag_weight <- median(coffee_new_1$Bag.Weight, na.rm = T)
coffee_new_1[is.na(coffee_new_1$Bag.Weight), 10.000] = median_Bag_weight

# Then drop any other NA from the character variables

coffee_new_1 <- na.omit(coffee_new_1)
```

- Maybe here we can show the visual representation of before and after cleaning the data

data transformation - Min- Max Normalisation
```{r}
colSums(is.na(coffee_new))
which(is.null(coffee_new))
str(coffee_new)

MinMax <- function(x){
  tx <- (x - min(x)) / (max(x) - min(x))
  return(tx)
}
# Line 337 to line 345 are giving errors
#coffee_new_1 <- apply(coffee_new[ ,c(-1,-4,-17,-18,-19) ], 2, MinMax)
#coffee_new_1 <- as.data.frame(coffee_new_1)
#colnames(coffee_new)

#coffee_new_1$Country.of.Origin <- coffee_new$Country.of.Origin
#coffee_new_1$Processing.Method <- coffee_new$Processing.Method
#coffee_new_1$Category.One.Defects <- coffee_new$Category.One.Defects
#coffee_new_1$Quakers <- coffee_new$Quakers
#coffee_new_1$Category.Two.Defects <- coffee_new$Category.Two.Defects
```

# Identify and Remove Outliers

```{r}
# function to understand if all the variables were correctly converted 
str(coffee_new_1)
```

# 1- Country.of.Origin 

```{r}
# function returns the frequency for this variable - makes it possible to identify any outliers
table(coffee_new_1$Country.of.Origin)

#Code to correct the value to Cote d'Ivoire
coffee_new_1["Country.of.Origin"][coffee_new_1["Country.of.Origin"] == "Cote d?Ivoire"] = "Cote d'Ivoire"

#Code to correct the value to United Republic of Tanzania
coffee_new_1["Country.of.Origin"][coffee_new_1["Country.of.Origin"] == "Tanzania, United Republic Of"] = "United Republic of Tanzania"
```

Table function shows that the variable country has one value for "Cote d?Ivoire". This country corresponds to Côte d'Ivoire and it might have been wrongly imputed. Moreover, the same happens with "Tanzania, United Republic Of" that should be United Republic of Tanzania.

Moreover, it is possible to investigate which countries produce more coffee - with the head, count and ggplot functions, as presented below. 

```{r}
head(coffee_new_1%>%
  count(Country.of.Origin)%>%
  arrange(desc(n)), 8)%>%
  ggplot(aes(x = n, y = reorder(Country.of.Origin, n))) + geom_bar(stat = "identity", fill = "#0072B2") + 
  labs(x = "Country", y = "Coffee Produced") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                                          panel.background = element_blank(), axis.line = element_line(colour = "pink"))
```

The output shows that Mexico, Guatemala and Colombia are the countries that produce more quantities of coffee.


# 2- Number.of.Bags 

```{r}
# the variable was not previously converted and it should be numeric type.
coffee_new_1$Number.of.Bags <- as.numeric(coffee_new_1$Number.of.Bags)

# plot to investigate any outliers

ggplot(coffee_new_1) + aes(x = Number.of.Bags) + geom_histogram(bins = 30L, fill = "#0c4c8a") + theme_minimal()

# Use summary function to confirm any outliers - should be the maximum value for this variable 
summary(coffee_new_1$Number.of.Bags)
```

The histogram shows that the variable has one possible outlier -  there seems to be one observation higher than all other observations - it should correspond to the maximum value of this variable. 

To confirm if this value corresponds to the maximum, summary function shows a Max of 1062 - according to the histogram ploted above, this makes sense to be the outlier.

Moreover, it is then necessary to identify the problem with 1062 number of bags, as it is a value out of the ordinary for this variable.

```{r}
# boxplot function to identify the possible outlier
bags_boxplot <- boxplot(coffee_new_1$Number.of.Bags, plot = F)

# minimum function will get this number as the minimum outlier possible
bags_threshold <- min(bags_boxplot$out)

bags_threshold # returns 1062, which is the outlier identified in the summary function
```

To understand if 1062 is an outlier - investigate this value with subset function to understand which country has 1062 nuymber of bags.

```{r}
# function to identify which country has 1062 number of bags
subset(coffee_new_1, Number.of.Bags == 1062.0)

# function to understand if it is the norm for Brazil to have 1000 number of bags
subset(coffee_new_1, Country.of.Origin == "Brazil")
```

The first subset function shows that Brazil is the country with 1062 number of bags (possible outlier)

Additionally, The output shows that the country Brazil is not set to have 1000 number of bags as the norm. This means that 1062 number of bags is an outlier and needs further investigation.

However, for line 735, with 1062 number of bags, this variable has 6 quackers, which relates to the poor quality of this set of coffee beans. This explains why there are more number of bags - less quality coffee leads to the need to collect more beans, which leads to more number of bags.

Therefore, this coffee beans have less quality than others and that is why there are more number of bags for line 735 - which makes this instance not an outlier.


# 3 - Quakers - unripened coffee beans, often with a wrinkled surface, not darken well when roasted.

```{r}
# Function to get the frequency of this variable - it shows 2 NAs for this variable
coffee_new_1 %>% count(Quakers)

# this function replaces NA by 0
coffee_new_1[is.na(coffee_new_1$Quakers) , ] = 0

# Quakers are not necessarily less than 3, go up and change the validate function. 

ggplot(coffee_new_1, aes(Quakers)) + geom_bar(fill = "#0099F8") + ggtitle("Quakers in the coffee quality")
```

The count function output shows that the variable Quakers ranges from level 0 to 11 - being 11 maximum level of coffee roastiness. 

Moreover, the geom_bar plot shows no outliers - all the values range from 0 to 11 with no extreme values. However, the plot shows an extremely high frequency for level 0 of Quakers - this does not correspond to outliers as level 0 represents missing information for this variable.

# 4 - Processing.Method

```{r}
# Function to get the frequency of this variable - it shows 2 missing values for this variable
coffee_new_1 %>% count(Processing.Method)

# output shows NA, this function replaces NA by "Other"
coffee_new_1[is.na(coffee_new_1$Processing.Method) , ] <- "Other"

# function to check for outliers 
ggplot(coffee_new_1, aes(Processing.Method)) + geom_bar(fill="steelblue") + coord_flip() 

```

The output shows no outliers for the Processing.Method variable - it also shows that both NA was correctly replaced by "Other".
Moreover, the output also shows that "Washed/Wet" is the most used processing method and that "Pulped natural" is the least used.

Furthermore, it is crucial to investigate which processing method is used the most and the least - with the countries that produce more coffee (as previously investigated before) - this investigation will be presented below in the EDA part of the project.


# 5 -  Total.Cup.Points - score coffee on a standardized scale, from 0 to 100.

This variable should range from 0 to 100 and, for a better quality coffee, it should have a value between 80 to 90 (Authentic Coffee Co., 2022)
Basically, it represents an overall quality score for coffee.

```{r}
aggregate(coffee_new_1$Total.Cup.Points, list(coffee_new_1$Country.of.Origin), FUN=mean)

ggplot(coffee_new_1, aes(Total.Cup.Points)) + geom_histogram(binwidth = 4, color="black",fill="lightblue",linetype="dashed")
```

The output shows an average of Total.Cup.Points similar to all the countries in this dataset. This means that there are not potential outliers for the Total.Cup.Points variable.

Moreover, the output shows that countries like Cote d'Ivoire, Haiti, India and Nicaragua have a poor Total.Cup.Points value, as it is less than 80.

Concluding, this list shows no outliers as all the values range from 0 to 100.


# 6 - Aroma, Flavor, Aftertaste, Acidity, Body, Balance, Uniformity, Clean.Cup, Sweetness

The coffee quality can be measured by professionals according to several factors such as: Acidity, Aroma, Flavor, Balance, Sweetness, among
others. They also grade each one of these factors in order to get the final score, which indicates the quality of this coffee (Souza, 2022).

Distribution of this variables is presented below.

```{r}
# the variable was not previously converted and it should be numeric type.
coffee_new_1$Sweetness <- as.numeric(coffee_new_1$Sweetness)

# the variable was not previously converted and it should be numeric type.
coffee_new_1$Cupper.Points <- as.numeric(coffee_new_1$Cupper.Points)


# Plot (geo point) function to investigate the distribution of each numerical variables and identify possible outliers.


ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Aroma)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Aroma") +
  xlab("Observations") + ylab("Aroma") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Flavor)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Flavor") +
  xlab("Observations") + ylab("Flavor") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Aftertaste)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Aftertaste") +
  xlab("Observations") + ylab("Aftertaste") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Acidity)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Acidity") +
  xlab("Observations") + ylab("Acidity") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Body)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Body") +
  xlab("Observations") + ylab("Body") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Balance)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Balance") +
  xlab("Observations") + ylab("Balance") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Uniformity)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Uniformity") +
  xlab("Observations") + ylab("Uniformity") +
  theme_classic()

ggplot(coffee_new, aes(x = 1:nrow(coffee_new), y = Sweetness)) +      # Getting all the data points for the x and y axis 
  geom_point(size=2, color = "goldenrod2") +
  ggtitle("Plot of the Sweetness") +
  xlab("Observations") + ylab("Sweetness") +
  theme_classic()
```

The geom_point output above represented show two possible outliers - for variables Aroma and Acidity.
To better understand this outliers, it is necessary to use the boxplot and minimum functions below presented.

Moreover, the geom_point output does not present any outlier and shows that Flavor-Aroma and Acidity-Aftertaste have a positive correlation between them.

```{r}
# AROMA VARIABLE
Aroma_boxplot <- boxplot(coffee_new_1$Aroma, plot = F)
Aroma_threshold <- min(Aroma_boxplot$out)
Aroma_threshold # value of the possible outlier for aroma is 5.08

# ACIDITY VARIABLE
Acidity_boxplot <- boxplot(coffee_new_1$Acidity, plot = F)
Acidity_threshold <- min(Acidity_boxplot$out)
Acidity_threshold # value of the possible outlier for aroma is 5.25

# BODY VARIABLE
Body_boxplot <- boxplot(coffee_new_1$Body, plot = F)
Body_threshold <- min(Body_boxplot$out)
Body_threshold # value of the possible outlier for aroma is 6.33

# subset fuction to extract the possible outliers
subset(coffee_new_1, Aroma == 5.08)
subset(coffee_new_1, Acidity == 5.25)
subset(coffee_new_1, Body == 6.33)
```

The first one, happens when  Aroma = 5.08 and Acidity = 5.25. However, even thought these two variables are out of the mean values, they stil range between 0-10, which means that they should not be outliers.

(Shows a value of 6.33 for Body when Acidity is 7.08 - even thought is a high value for body when compared with the rest of the variable but it is still within the correct range).


# 7 - Cupper.Points and Clean.Cup

Furthermore, the two variables 
Cupper.Points - Any negative marks that appear in the Uniformity, Clean Cup and Sweetness categories are deducted as two points per cup 
# and
Clean.Cup - refers to a coffee free of taints and defects.

```{r}
ggplot(coffee_new_1, aes(Cupper.Points)) + geom_histogram(binwidth = 0.3)

ggplot(coffee_new_1, aes(Clean.Cup)) + geom_histogram(binwidth = 0.5)

# count function to confirm there are no outliers as represented in the ggplot output
coffee_new_1 %>% count(Cupper.Points)
coffee_new_1 %>% count(Clean.Cup)

table(coffee_new_1$Clean.Cup)
```

The output does not present any possible outlier for these two variables.
Furthermore, as the clean.cup variable corresponds to a coffee free of taints and defects, it makes sense to have 1057 count when clean cup is equal to 10. This means that 1057 coffee beans have no defects.


# 8 - Moisture

```{r}
ggplot(coffee_new_1, aes(Moisture)) + geom_histogram(binwidth = 0.10)

table(coffee_new_1$Moisture)

# SHOULD WE REMOVE ALL 0 FROM THIS VARIABLE AS THEY ARE OUTLIERS ?
```

The ggplot output shows that this variable does not present any outlier - most coffee beans have a 0.1 level of moisture.

# 8 - Category.One.Defects and Category.Two.Defects

According to Hetzel (2022), bean defects of Category One are rare, as are Quakers - imperfections in the coffee quality that affect its characteristics like Aroma, Acidity, etc.
Bean defects of Category Two are more common and the distribution appears to be approximately log-normal.

```{r}
ggplot(coffee_new_1, aes(Category.One.Defects, Category.Two.Defects)) + geom_boxplot()

ggplot(coffee_new_1, aes(Category.One.Defects)) + geom_histogram(binwidth = 10)
ggplot(coffee_new_1, aes(Category.Two.Defects)) + geom_histogram(binwidth = 10)
```

I do not really understand what these two categories are - could not find anything good on the internet.
Therefore, both variables need further investigation. 

```{r}
ggplot(coffee_new_1, aes(Category.One.Defects, Category.Two.Defects)) + geom_boxplot()
```

ggplot output shows many outliers for the Category.Two.Defects variable - needs further investigation.

```{r}
# boxplot to identify all these outliers
category_boxplot <- boxplot(coffee_new_1$Category.Two.Defects, plot = F)

# minimum function will set one outlier as the first outlier, which means that all numbers above that one will be considered to be outliers
category_threshold <- min(category_boxplot$out)

# function to remove the previously identified outliers
dataset_clean <- coffee_new_1[coffee_new_1$Category.Two.Defects< min(category_boxplot$out), ]
dataset_clean
```


# 4. Exploratory Data Analysis

# Research question:

"Given the Quality measures of the Arabica Coffee beans, can we predict the overall coffee quality score?"

Regression Analysis (Target Variable - Total.Cup.Points)

# EDA Plan:

# 1 - Explore each variable individually to understand if they are normally distributed and can be used in a regression analysis 

```{r}
ggplot(coffee_new_1, aes(x=Total.Cup.Points)) + 
  
  geom_histogram(aes(y=..density..),      
                 binwidth=1,
                 colour="black", fill="goldenrod2") +
  # Overlay with transparent (use the alpha parameter) blue density plot  
  geom_density(alpha=.2, fill="black") +   
  xlab("Coffee Cup Score") +
  ggtitle("Histogram and density plot of Cup Score")
```

The histogram output shows that Total.Cup.Points variable is normally distributed but slightly skewed to the right.
Moreover, the output also shows that most of the coffee beans have a score between 80 and 85.

Many research shows that Total.Cup.Points represents the coffee quality by gathering data from different variables: Aroma, Flavor, Aftertaste, Acidity, Body, Balance and Sweetness - therefore, these variables need further investigation 
Note: summary function was used with this variables to investigate if they have similar values for mean and median; meaning that they might be normal distributed.


```{r}
# (Note: Displaying 4 histograms together at a time, is done using the par() function.)

#variable's distribution with histogram - histogram is used to display the distribution of continuous variables.

# the variables visual representation is divided into two parts; for a better understanding of the data.
# Part I with variables: Aroma, Flavor, Aftertaste and Acidity.
# Part II with variables: Body, Balance and Sweetness.

par(mfrow=c(1,4)) # Part I

hist(coffee_new_1$Aroma, main="Histogram of coffee Aroma",xlab="Coffee´s Aroma", ylab="")

hist(coffee_new_1$Flavor, main="Histogram of coffee Flavor",xlab="Coffee´s Flavor", ylab="")

hist(coffee_new_1$Aftertaste, main="Histogram of coffee Aftertaste",xlab="Coffee´s Aftertaste", ylab="")

hist(coffee_new_1$Acidity, main="Histogram of coffee Acidity",xlab="Coffee´s Acidity", ylab="")

par(mfrow=c(1,4)) # Part II

hist(coffee_new_1$Body, main="Histogram of coffee Body",xlab= "Coffee´s Body", ylab="")

hist(coffee_new_1$Balance, main="Histogram of coffee Balance",xlab="Coffee´s Balance", ylab="")

hist(coffee_new_1$Sweetness, main="Histogram of coffee Sweetness",xlab="Coffee´s Sweetness", ylab="")

```
Part I output shows that the four variables are normally distributed and, Part II, shows that variables Body and Balance present a similar distribution. However, variable Sweetness does not behave the same way and needs further investigation.

Furthermore, table function is used in the Sweetness variable to understand its distribution. 

```{r}
table(coffee_new_1$Sweetness)
```

Sweetness are generally highly rated with little deviation from scores of 10, as shown in the table function output and this variable´s histogram.
Research shows that coffee beans are known for their sweetness - Colombia, Kenya, Guatemala, Panama, and Ethiopia are the countries producing the most sweet coffee beans (Coffee, 2022, find at: https://dialupthecoffee.com/naturally-sweet-coffee/).


Moreover, it is important to understand how variables Category.One/Two.Defects and Quakers behave - as having quakers leads to defects in coffee beans.

```{r}
ggplot(coffee_new_1, aes(Category.One.Defects)) + geom_area(stat = "bin") + ggtitle("Category One Defects")

ggplot(coffee_new_1, aes(Category.Two.Defects)) + geom_area(stat = "bin") + ggtitle("Category Two Defects")

ggplot(coffee_new_1, aes(Quakers)) + geom_histogram(binwidth = 0.9) + ggtitle("Coffee Quakers")
```

The output shows two things:
1 - Category.One.Defects type of bean are rare, as are Quakers
2 - Category.Two.Defects bean are more common and the distribution appears to be approximately log-normal.


##### Appendix ? ahah

Furthermore, it is necessary to investigate which processing method is used the most and the least - with the countries that produce more coffee, as outlined in the data cleaning stage of this project.

```{r}
coffee_new_1%>%
  filter(Country.of.Origin %in% c(coffee_new_1%>%
                                    count(Country.of.Origin)%>%
                                    filter(n >25)%>%
                                    pull(Country.of.Origin)))%>%
  filter(Processing.Method %in% c('Washed / Wet', 'Natural / Dry'))%>%
  count(Country.of.Origin, Processing.Method)%>%
  mutate(country = factor(Country.of.Origin, levels = c("Mexico", "Guatemala", "Colombia", "Brazil", 
                                                        "Taiwan", "United States (Hawaii)", "Honduras", "Costa Rica")))%>%
  ggplot(aes(x = country, y = n, fill = reorder(Processing.Method,-n))) + geom_col() +
  labs(x = 'Number of Coffee',
       y = 'Country', fill = 'Process Method') + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                                                       panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_fill_manual(values=c("azure3","#0072B2"))
```

The output shows that Natural/Dry processing methods are mostly used in Brazil. The plot also shows that Washed/Wet processing methods are mostly used in Countries like Mexico, Guatemala and Colombia - as these countries produce more coffee, it is possible to conclude that Washed and Wet processing methods produce better results.

##### Appendix ?


# 2 - analyse the continuous variables graphically against the Total.Cup.Points variable to understand if they affect that variable. If variables affect the Total.Cup.Points of coffee quality, then they should be taken into the Total.Cup.Points regression model.

# Country.of.Origin

```{r}
ggplot(coffee_new_1, aes(Country.of.Origin, Total.Cup.Points)) + geom_boxplot() + coord_flip()
```
The output shows it impossible to find a pattern between the relationship of total cup points and country of origin.
Ethiopian, United States and Panama appears to be generally the coffee with highest scores.


# Processing.Method

```{r}
ggplot(coffee_new_1, aes(Processing.Method, Total.Cup.Points)) + geom_boxplot() + coord_flip()
```

The output shows that Washed/Wet processing method is the one with lowest coffee quality scores (Total Cup Points).
Furthermore, there are no visible trends within the data as all variables have similar means, meaning, similar coffee quality scores.


# Category.One.Defects, Category.Two.Defects and Quakers

```{r}
#plot(coffee_new_1, aes(Category.One.Defects, Total.Cup.Points))
par(mfrow=c(1,3)) # Part II
attach(coffee_new_1)
plot(Total.Cup.Points, Category.One.Defects, main="Defects type I vs Coffee Score", 
   xlab="Total.Cup.Points", ylab="Category.One.Defects", pch=19)

plot(Total.Cup.Points, Category.Two.Defects, main="Defects type II vs Coffee Score", 
   xlab="Total.Cup.Points", ylab="Category.Two.Defects", pch=19)

plot(Quakers, Quakers, Total.Cup.Points="Quakers vs Coffee Score", 
   xlab="Quakers", ylab="Total.Cup.Points", pch=19)
```

The output shows that for best coffee quality scores ( >80 Total.Cup.Points) happens when the number of defects and Quakers are low.
Therefore, variables like Category.One.Defects, Category.Two.Defects and Quakers affect the likelihood of increasing/decreasing the variable Total.Cup.Points - and should be included in the regression model.
